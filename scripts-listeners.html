<script>
// vim: ts=3

let METADATA = {% include metadata/works.json %};
let COMPOSERS = {% include metadata/composers.json %};

//////////////////////////////
//
// DOMContentLoaded event -- run after webpage has finished loading.
//

document.addEventListener("DOMContentLoaded", function () {
	fillMostRecentList(METADATA);
	displayTopComposers(METADATA);
	setupUserSearchEnterKey();
});



//////////////////////////////
//
// setupUserSearchEnterKey -- Allow the Enter key to move you to the repertoire page.
//

function setupUserSearchEnterKey() {
	let searchElement = document.querySelector("#input");
	if (searchElement) {
		searchElement.addEventListener("keydown", function(event) {
			if (event.key == 'Enter') {
				UserSearch();
			}
		});
	}
}

//////////////////////////////
//
// Live search (DOMContentLoaded-safe)
//

document.addEventListener("DOMContentLoaded", function () {

  const searchInput = document.querySelector("#input");
  const suggestionPanel = document.querySelector("#search-suggestions");

  if (!searchInput || !suggestionPanel) {
    console.warn("Search input or suggestion panel not found.");
    return;
  }

  const WORK_SUGGESTION_LIMIT = 4;
  const COMPOSER_SUGGESTION_LIMIT = 3;

  searchInput.addEventListener("input", function () {
    const q = this.value.toLowerCase().trim();

    if (q.length < 2) {
      suggestionPanel.classList.add("hidden");
      suggestionPanel.innerHTML = "";
      return;
    }

    // --- Composer matches (ranked first)
    const composerMatches = COMPOSERS
      .filter(c =>
        c.Composer &&
        c.Composer.toLowerCase().includes(q)
      )
      .slice(0, COMPOSER_SUGGESTION_LIMIT);

    // --- Work matches
    const workMatches = METADATA
      .filter(entry => {
        return (
          entry.Composer?.toLowerCase().includes(q) ||
          entry.Title?.toLowerCase().includes(q) ||
          entry.Subtitle?.toLowerCase().includes(q) ||
          entry.Genre?.toLowerCase().includes(q) ||
          entry["First Source"]?.toLowerCase().includes(q)
        );
      })
      .slice(0, WORK_SUGGESTION_LIMIT);

    if (composerMatches.length === 0 && workMatches.length === 0) {
      suggestionPanel.classList.add("hidden");
      suggestionPanel.innerHTML = "";
      return;
    }

    suggestionPanel.innerHTML = [
      ...composerMatches.map(renderComposerSuggestion),
      ...workMatches.map(renderSuggestion),
      renderSeeMoreRow(q)
    ].join("");

    suggestionPanel.classList.remove("hidden");
  });

  // Hide suggestions when clicking outside search
  document.addEventListener("click", function (e) {
    if (!e.target.closest(".apple-search")) {
      suggestionPanel.classList.add("hidden");
    }
  });

});

document.addEventListener("click", function (e) {
  const composerRow = e.target.closest(".composer-suggestion");
  if (!composerRow) return;

  const composerId = composerRow.dataset.id;
  if (!composerId) return;

  window.location.href = `/repertoire/?c=${encodeURIComponent(composerId)}`;
});

</script>